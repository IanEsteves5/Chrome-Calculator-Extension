var tokenTypes=[new tokenType("ws","\\s+"),new tokenType("id","[a-zA-Z_]\\w*"),new tokenType("real","\\d*\\.\\d+"),new tokenType("int","\\d+"),new tokenType(":=",":="),new tokenType(">=",">="),new tokenType("<=","<="),new tokenType("!=","!="),new tokenType("(","\\("),new tokenType(")","\\)"),new tokenType("+","\\+"),new tokenType("-","-"),new tokenType("*","\\*"),new tokenType("/","/"),new tokenType("%","%"),new tokenType("^","\\^"),new tokenType(">",">"),new tokenType("<","<"),new tokenType("=","="),new tokenType("!","!"),new tokenType("&","&"),new tokenType("|","\\|"),new tokenType("?","\\?"),new tokenType(":",":"),new tokenType(",",","),new tokenType("err",".*")];var rules=[new rule("INPUT",[new pattern(["EXPR"],function(a){return a[0].val()}),new pattern(["B_EXPR"],function(a){return a[0].val()}),new pattern(["ERROR"],function(a){return a[0].val()})]),new rule("EXPR",[new pattern(["id",":=","EXPR2"],function(a){return memory.set(a[0].val(),a[2].val())}),new pattern(["EXPR2"],function(a){return a[0].val()})]),new rule("EXPR2",[new pattern(["B_EXPR","?","EXPR3",":","EXPR3"],function(a){return a[0].val()?a[2].val():a[4].val()}),new pattern(["EXPR3"],function(a){return a[0].val()})]),new rule("EXPR3",[new pattern(["EXPR3","+","EXPR4_R+"],function(a){return a[0].val()+a[2].val()}),new pattern(["EXPR3","-","EXPR4_R+"],function(a){return a[0].val()-a[2].val()}),new pattern(["EXPR4"],function(a){return a[0].val()})]),new rule("EXPR4",[new pattern(["EXPR4","*","EXPR5"],function(a){return a[0].val()*a[2].val()}),new pattern(["EXPR4","/","EXPR5"],function(a){var b=a[2].val();if(b===0){pushErrorLog("division by zero",a[1].pos)}return a[0].val()/b}),new pattern(["EXPR4","%","EXPR5"],function(a){return a[0].val()%a[2].val()}),new pattern(["EXPR5"],function(a){return a[0].val()})]),new rule("EXPR4_R+",[new pattern(["EXPR4_R+","*","EXPR5"],function(a){return a[0].val()*a[2].val()}),new pattern(["EXPR4_R+","/","EXPR5"],function(a){var b=a[2].val();if(b===0){pushErrorLog("division by zero",a[1].pos)}return a[0].val()/b}),new pattern(["EXPR4_R+","%","EXPR5"],function(a){return a[0].val()%a[2].val()}),new pattern(["EXPR5_R+"],function(a){return a[0].val()})]),new rule("EXPR5",[new pattern(["EXPR5","^","EXPR6"],function(a){return Math.pow(a[0].val(),a[2].val())}),new pattern(["EXPR6"],function(a){return a[0].val()})]),new rule("EXPR5_R+",[new pattern(["EXPR5_R+","^","EXPR6"],function(a){return Math.pow(a[0].val(),a[2].val())}),new pattern(["EXPR7"],function(a){return a[0].val()})]),new rule("EXPR6",[new pattern(["+","EXPR7"],function(a){return a[1].val()}),new pattern(["-","EXPR7"],function(a){return -a[1].val()}),new pattern(["EXPR7"],function(a){return a[0].val()})]),new rule("EXPR7",[new pattern(["id","(","ARGS",")"],function(a){for(var b=0;b<mathFunctions.length;b++){if(mathFunctions[b].id===a[0].val()){if(mathFunctions[b].numArgs!==a[2].val().length){pushErrorLog(a[0].val()+" expected "+mathFunctions[b].numArgs+(mathFunctions[b].numArgs===1?" argument":" arguments"),a[0].pos);return Number.NaN}return mathFunctions[b].action(a[2].val(),a[0].token.pos)}}pushErrorLog("undefined function "+a[0].val(),a[0].pos);return Number.NaN}),new pattern(["id","(",")"],function(a){for(var b=0;b<mathFunctions.length;b++){if(mathFunctions[b].id===a[0].val()){if(mathFunctions[b].numArgs!==0){pushErrorLog(a[0].val()+" expected "+mathFunctions[b].numArgs+(mathFunctions[b].numArgs===1?" argument":" arguments"),a[0].pos);return Number.NaN}return mathFunctions[b].action([],a[0].token.pos)}}pushErrorLog("undefined function "+a[0].val(),a[0].pos);return Number.NaN}),new pattern(["(","EXPR",")"],function(a){return a[1].val()}),new pattern(["NUM"],function(a){return a[0].val()}),new pattern(["id"],function(a){var b=memory.get(a[0].val());if(b!==null){return b}pushErrorLog("undefined variable "+a[0].val(),a[0].pos);return Number.NaN})]),new rule("ARGS",[new pattern(["ARGS",",","EXPR"],function(a){return a[0].val().concat(a[2].val())}),new pattern(["EXPR"],function(a){return[a[0].val()]})]),new rule("NUM",[new pattern(["int"],function(a){return parseInt(a[0].val())}),new pattern(["real"],function(a){return parseFloat(a[0].val())})]),new rule("B_EXPR",[new pattern(["B_EXPR","|","B_EXPR2"],function(a){return a[0].val()||a[2].val()}),new pattern(["B_EXPR2"],function(a){return a[0].val()})]),new rule("B_EXPR2",[new pattern(["B_EXPR2","&","B_EXPR3"],function(a){return a[0].val()&&a[2].val()}),new pattern(["B_EXPR3"],function(a){return a[0].val()})]),new rule("B_EXPR3",[new pattern(["!","B_EXPR4"],function(a){return !a[1].val()}),new pattern(["B_EXPR4"],function(a){return a[0].val()})]),new rule("B_EXPR4",[new pattern(["(","B_EXPR",")"],function(a){return a[1].val()}),new pattern(["COMP"],function(a){return a[0].val()})]),new rule("COMP",[new pattern(["EXPR","=","EXPR"],function(a){return a[0].val()===a[2].val()}),new pattern(["EXPR","!=","EXPR"],function(a){return a[0].val()!==a[2].val()}),new pattern(["EXPR",">","EXPR"],function(a){return a[0].val()>a[2].val()}),new pattern(["EXPR","<","EXPR"],function(a){return a[0].val()<a[2].val()}),new pattern(["EXPR",">=","EXPR"],function(a){return a[0].val()>=a[2].val()}),new pattern(["EXPR","<=","EXPR"],function(a){return a[0].val()<=a[2].val()})]),new rule("ERROR",[new pattern([],function(a){errorLog="";for(var c=0;c<a.length;c++){if(a[c].id==="err"){pushErrorLog("unexpected input "+a[c].val(),a[c].pos);continue}if(a[c].id==="+"||a[c].id==="-"){var d=a[c].id;for(var b=c+1;b<a.length&&(a[b].id==="+"||a[b].id==="-");b++){d+=a[b].id}if(d.length>1){pushErrorLog("unexpected input "+d,a[c].pos);c+=d.length-1}continue}}return null})])];var mathFunctions=[new mathFunction("log",["x","b"],function(a,b){if(a[0]<0){pushErrorLog("log of negative number",b);return Number.NaN}return Math.log(a[0])/Math.log(a[1])}),new mathFunction("trunc",["x","n"],function(a,c){var b=Math.pow(10,Math.floor(a[1]));return Math.floor(a[0]*b)/b}),new mathFunction("rad",["x","y"],function(a,b){return Math.sqrt(a[0]*a[0]+a[1]*a[1])}),new mathFunction("ang",["x","y"],function(a,b){return Math.atan(a[1]/a[0])}),new mathFunction("exp",["x"],function(a,b){return Math.exp(a[0])}),new mathFunction("ln",["x"],function(a,b){if(a[0]<0){pushErrorLog("log of negative number",b);return Number.NaN}return Math.log(a[0])}),new mathFunction("log2",["x"],function(a,b){if(a[0]<0){pushErrorLog("log of negative number",b);return Number.NaN}return Math.log(a[0])/Math.LN2}),new mathFunction("log10",["x"],function(a,b){if(a[0]<0){pushErrorLog("log of negative number",b);return Number.NaN}return Math.log(a[0])/Math.LN10}),new mathFunction("sqrt",["x"],function(a,b){return Math.sqrt(a[0])}),new mathFunction("round",["x"],function(a,b){return Math.round(a[0])}),new mathFunction("floor",["x"],function(a,b){return Math.floor(a[0])}),new mathFunction("abs",["x"],function(a,b){return Math.abs(a[0])}),new mathFunction("sin",["x"],function(a,b){return Math.sin(a[0])}),new mathFunction("cos",["x"],function(a,b){return Math.cos(a[0])}),new mathFunction("tan",["x"],function(a,b){return Math.tan(a[0])}),new mathFunction("asin",["x"],function(a,b){if(a[0]>1||a[0]<-1){pushErrorLog("invalid argument for asin "+a[0],b);return Number.NaN}return Math.asin(a[0])}),new mathFunction("acos",["x"],function(a,b){if(a[0]>1||a[0]<-1){pushErrorLog("invalid argument for acos "+a[0],b);return Number.NaN}return Math.acos(a[0])}),new mathFunction("atan",["x"],function(a,b){return Math.atan(a[0])}),new mathFunction("sinh",["x"],function(a,b){return Math.sinh(a[0])}),new mathFunction("cosh",["x"],function(a,b){return Math.cosh(a[0])}),new mathFunction("tanh",["x"],function(a,b){return Math.tanh(a[0])}),new mathFunction("asinh",["x"],function(a,b){return Math.asinh(a[0])}),new mathFunction("acosh",["x"],function(a,b){if(a[0]<1){pushErrorLog("invalid argument for acosh "+a[0],b);return Number.NaN}return Math.acosh(a[0])}),new mathFunction("atanh",["x"],function(a,b){if(a[0]>1||a[0]<-1){pushErrorLog("invalid argument for atanh "+a[0],b);return Number.NaN}return Math.atanh(a[0])}),new mathFunction("fact",["n"],function(b,d){if(b[0]<1){return 0}var a=1;for(var c=Math.floor(b[0]);c>1;c--){if(a===Number.POSITIVE_INFINITY){break}a*=c}return a}),new mathFunction("random",[],function(a,b){return Math.random()}),new mathFunction("pi",[],function(a,b){return Math.PI}),new mathFunction("e",[],function(a,b){return Math.E})];var memory=[];memory.set=function(c,b){for(var a=0;a<this.length;a++){if(this[a].id===c){return this[a].val=b}}this.push(new memoryEntry(c,b));return b};memory.get=function(b){for(var a=0;a<this.length;a++){if(this[a].id===b){return this[a].val}}return null};memory.empty=function(){this.length=0};var errorLog="";function getTokens(d){var c=[];var a="";for(var e=0;e<d.length;e+=a.length){for(var b=0;b<tokenTypes.length;b++){a=tokenTypes[b].regex.exec(d.substring(e));if(a!==null){a=a[0];c.push(new token(tokenTypes[b].id,e,a));break}}}return c}function isTokenType(b){for(var a=0;a<tokenTypes.length;a++){if(tokenTypes[a].id===b){return true}}return false}function getParseTree(c){var a=[];for(var b=0;b<c.length;b++){if(c[b].id!=="ws"){a.push(c[b])}}return rules[0].getParseTree(a,0,true)}function calculate(a){errorLog="";return getParseTree(getTokens(a)).val()}function pushErrorLog(a,b){errorLog+=(errorLog===""?"":"\n")+"["+(b+1)+"] "+a}function tokenType(b,a){this.id=b;this.regexStr=a;this.regex=new RegExp("^"+a)}function token(c,b,a){this.id=c;this.pos=b;this.content=a}function rule(b,a){this.id=b;this.patterns=a;this.getParseTree=function(g,c,f){for(var d=0;d<this.patterns.length;d++){var e=this.patterns[d].getParseTree(g,c,f);if(e!==null){e.id=b;return e}}return null}}function pattern(b,a){this.elements=b;this.getPatternString=function(){return"["+this.elements.join(" ")+"]"};this.getParseTree=function(n,k,g){for(var h=0;h<this.elements.length;h++){if(isTokenType(this.elements[h])){var o=false;var c=0;for(var f=c;f<n.length-k;f++){if(this.elements[h]===n[f].id){o=true;c=f+1;break}}if(!o){return null}}}var d=[];var m=n.length-k;var l=this.elements.length;if(l===0){for(var h=0;h<m;h++){d.push(new parseTreeTerminalNode(n[h]))}return new parseTreeNode(d,a)}while(m>0&&l>0){l--;var e=null;if(this.elements[l]===n[m-1].id){e=new parseTreeTerminalNode(n[m-1])}else{for(var h=0;h<rules.length;h++){if(this.elements[l]===rules[h].id){e=rules[h].getParseTree(n,n.length-m,g&&l===0);break}}}if(e===null){return null}d.unshift(e);m-=e.tokensUsed()}if(l>0){return null}if(g&&m>0){return null}return new parseTreeNode(d,a)}}function parseTreeNode(a,b){this.id="";this.children=a;this.val=function(){return b(a)};this.pos=this.children[0].pos;this.tokensUsed=function(){result=0;for(var c=0;c<a.length;c++){result+=a[c].tokensUsed()}return result}}function parseTreeTerminalNode(a){this.id=a.id;this.children=[];this.token=a;this.val=function(){return this.token.content};this.pos=a.pos;this.tokensUsed=function(){return 1}}function mathFunction(c,a,b){this.id=c;this.argNames=a;this.numArgs=a.length;this.action=function(d,e){return b(d,e)}}function memoryEntry(b,a){this.id=b;this.val=a};